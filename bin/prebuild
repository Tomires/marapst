#!/usr/bin/env node
var fs = require('fs')
var path = require('path')

var questions = fs.readdirSync(path.join(__dirname, '../questions'))

var count = 0
var contributors = []
var qOutput = []

for (var question of questions) {
  if (question.substr(-2) === 'md' && question !== 'example.md' && question !== 'template.md') {
    var file = fs.readFileSync(path.join(__dirname, '../questions', question), 'utf8')

    var author = /author: (.+)\n/g.exec(file)[1]
    if (contributors.indexOf(author) == -1) contributors.push(author)

    count += 1
    var id = parseInt(question.substring(0, question.lastIndexOf('.')))

    var questionMarkdown = /# Zadání((.|\n)*)# Řešení/g.exec(file)[1]

    qOutput[id] = {
      file: question,
      peek: questionMarkdown.substring(0, 64)
    }

    console.log('Meta for ' + question + ' saved.')
  }
}

var meta = {
  built: new Date().toISOString(),
  c: count,
  contribs: contributors,
  tags: 'tbp',
  q: qOutput
}

fs.writeFile(path.join(__dirname, '../questions/meta.json'), JSON.stringify(meta), function () {
  console.log(`Prebuilded. ${meta.c} questions meta saved.`)
})
